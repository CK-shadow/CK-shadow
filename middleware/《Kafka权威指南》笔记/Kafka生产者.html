<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Kafka生产者 | Simon的书柜</title>
    <meta name="description" content="Simon的书柜">
    <link rel="icon" href="/img/geass-bg.ico">
    
    <link rel="preload" href="/assets/css/0.styles.ee1f0b8d.css" as="style"><link rel="preload" href="/assets/js/app.8e4ddb9b.js" as="script"><link rel="preload" href="/assets/js/3.ba518dde.js" as="script"><link rel="preload" href="/assets/js/1.86969b9d.js" as="script"><link rel="preload" href="/assets/js/61.ec1a5950.js" as="script"><link rel="prefetch" href="/assets/js/10.46f1c292.js"><link rel="prefetch" href="/assets/js/100.246ace36.js"><link rel="prefetch" href="/assets/js/101.58aaf7cf.js"><link rel="prefetch" href="/assets/js/102.a2c01ed0.js"><link rel="prefetch" href="/assets/js/103.10c9a533.js"><link rel="prefetch" href="/assets/js/104.e6338135.js"><link rel="prefetch" href="/assets/js/105.fad4dcd3.js"><link rel="prefetch" href="/assets/js/106.408b3cc4.js"><link rel="prefetch" href="/assets/js/107.f86a2752.js"><link rel="prefetch" href="/assets/js/108.84eb9074.js"><link rel="prefetch" href="/assets/js/109.9c2b6843.js"><link rel="prefetch" href="/assets/js/11.0bc9285c.js"><link rel="prefetch" href="/assets/js/110.ffff6231.js"><link rel="prefetch" href="/assets/js/111.109ffdad.js"><link rel="prefetch" href="/assets/js/112.e13914e5.js"><link rel="prefetch" href="/assets/js/113.a11fe8c5.js"><link rel="prefetch" href="/assets/js/114.42f84a11.js"><link rel="prefetch" href="/assets/js/115.b2b1bf91.js"><link rel="prefetch" href="/assets/js/116.3a07bd48.js"><link rel="prefetch" href="/assets/js/117.25a141a7.js"><link rel="prefetch" href="/assets/js/118.8970a20f.js"><link rel="prefetch" href="/assets/js/119.6d16c9cd.js"><link rel="prefetch" href="/assets/js/12.6b89d907.js"><link rel="prefetch" href="/assets/js/120.3197a34d.js"><link rel="prefetch" href="/assets/js/121.847f7e5d.js"><link rel="prefetch" href="/assets/js/122.8ce135b7.js"><link rel="prefetch" href="/assets/js/123.9c430eb9.js"><link rel="prefetch" href="/assets/js/124.23dd24ab.js"><link rel="prefetch" href="/assets/js/125.c943a817.js"><link rel="prefetch" href="/assets/js/126.6e69deca.js"><link rel="prefetch" href="/assets/js/127.72ea646d.js"><link rel="prefetch" href="/assets/js/128.eec59ddd.js"><link rel="prefetch" href="/assets/js/129.f87a65d8.js"><link rel="prefetch" href="/assets/js/13.46b9d829.js"><link rel="prefetch" href="/assets/js/130.dd36ac7d.js"><link rel="prefetch" href="/assets/js/131.b1d62a81.js"><link rel="prefetch" href="/assets/js/132.5d2406ac.js"><link rel="prefetch" href="/assets/js/133.e1c1db90.js"><link rel="prefetch" href="/assets/js/134.9b4537aa.js"><link rel="prefetch" href="/assets/js/135.4e7133ae.js"><link rel="prefetch" href="/assets/js/136.07c74d14.js"><link rel="prefetch" href="/assets/js/137.3e319ac4.js"><link rel="prefetch" href="/assets/js/138.c870a62a.js"><link rel="prefetch" href="/assets/js/139.1e96020f.js"><link rel="prefetch" href="/assets/js/14.ee8f697e.js"><link rel="prefetch" href="/assets/js/140.477ebe45.js"><link rel="prefetch" href="/assets/js/141.e0ae13dc.js"><link rel="prefetch" href="/assets/js/142.5c493cb4.js"><link rel="prefetch" href="/assets/js/143.1fa70ce1.js"><link rel="prefetch" href="/assets/js/144.5bb1229c.js"><link rel="prefetch" href="/assets/js/145.0b52efde.js"><link rel="prefetch" href="/assets/js/146.a513efde.js"><link rel="prefetch" href="/assets/js/147.880ffd0f.js"><link rel="prefetch" href="/assets/js/148.c28add39.js"><link rel="prefetch" href="/assets/js/149.dd32a967.js"><link rel="prefetch" href="/assets/js/15.813442d0.js"><link rel="prefetch" href="/assets/js/150.be413fe5.js"><link rel="prefetch" href="/assets/js/151.18acaed1.js"><link rel="prefetch" href="/assets/js/152.1062308b.js"><link rel="prefetch" href="/assets/js/153.fa2b4c42.js"><link rel="prefetch" href="/assets/js/154.1e69187c.js"><link rel="prefetch" href="/assets/js/155.a9e9bafd.js"><link rel="prefetch" href="/assets/js/156.a89f0750.js"><link rel="prefetch" href="/assets/js/157.c40c7ee9.js"><link rel="prefetch" href="/assets/js/158.3520fe99.js"><link rel="prefetch" href="/assets/js/159.a45d152a.js"><link rel="prefetch" href="/assets/js/16.4dc4e051.js"><link rel="prefetch" href="/assets/js/160.0b16586f.js"><link rel="prefetch" href="/assets/js/161.396eff12.js"><link rel="prefetch" href="/assets/js/162.8d9599b9.js"><link rel="prefetch" href="/assets/js/163.40d7a1da.js"><link rel="prefetch" href="/assets/js/164.f55ffd88.js"><link rel="prefetch" href="/assets/js/165.2f06579b.js"><link rel="prefetch" href="/assets/js/166.552ea32d.js"><link rel="prefetch" href="/assets/js/167.0191c753.js"><link rel="prefetch" href="/assets/js/168.473050be.js"><link rel="prefetch" href="/assets/js/169.dfe9e753.js"><link rel="prefetch" href="/assets/js/17.cbf6bd7d.js"><link rel="prefetch" href="/assets/js/170.6a8c2f6e.js"><link rel="prefetch" href="/assets/js/171.9b7fcd9b.js"><link rel="prefetch" href="/assets/js/172.6c92bd3d.js"><link rel="prefetch" href="/assets/js/173.56173727.js"><link rel="prefetch" href="/assets/js/174.a65bff5b.js"><link rel="prefetch" href="/assets/js/175.88ba2e0f.js"><link rel="prefetch" href="/assets/js/176.282e9ce3.js"><link rel="prefetch" href="/assets/js/177.0a82b4b1.js"><link rel="prefetch" href="/assets/js/178.b8b06696.js"><link rel="prefetch" href="/assets/js/179.0eb5dd93.js"><link rel="prefetch" href="/assets/js/18.9b84d41b.js"><link rel="prefetch" href="/assets/js/180.2acaaea3.js"><link rel="prefetch" href="/assets/js/181.6d82234c.js"><link rel="prefetch" href="/assets/js/182.f02596ca.js"><link rel="prefetch" href="/assets/js/183.1f9feacd.js"><link rel="prefetch" href="/assets/js/184.18f552b6.js"><link rel="prefetch" href="/assets/js/185.e30b53e3.js"><link rel="prefetch" href="/assets/js/186.b4ffb375.js"><link rel="prefetch" href="/assets/js/187.46b529cc.js"><link rel="prefetch" href="/assets/js/188.261a291c.js"><link rel="prefetch" href="/assets/js/189.bd723e6b.js"><link rel="prefetch" href="/assets/js/19.f42f1625.js"><link rel="prefetch" href="/assets/js/190.5e0f5207.js"><link rel="prefetch" href="/assets/js/191.73d5db60.js"><link rel="prefetch" href="/assets/js/192.40f651d8.js"><link rel="prefetch" href="/assets/js/193.230ef92d.js"><link rel="prefetch" href="/assets/js/194.52cf4979.js"><link rel="prefetch" href="/assets/js/195.ae4d8414.js"><link rel="prefetch" href="/assets/js/20.ea647566.js"><link rel="prefetch" href="/assets/js/21.5259d585.js"><link rel="prefetch" href="/assets/js/22.5ad0fa4e.js"><link rel="prefetch" href="/assets/js/23.8dd0c71d.js"><link rel="prefetch" href="/assets/js/24.ed65199e.js"><link rel="prefetch" href="/assets/js/25.77a0b8a7.js"><link rel="prefetch" href="/assets/js/26.7ccdb52f.js"><link rel="prefetch" href="/assets/js/27.96a294cb.js"><link rel="prefetch" href="/assets/js/28.f5cc14bb.js"><link rel="prefetch" href="/assets/js/29.7d7e26a0.js"><link rel="prefetch" href="/assets/js/30.ae577a9d.js"><link rel="prefetch" href="/assets/js/31.3e57a3aa.js"><link rel="prefetch" href="/assets/js/32.2caf58ac.js"><link rel="prefetch" href="/assets/js/33.e3cf611a.js"><link rel="prefetch" href="/assets/js/34.6d288ae8.js"><link rel="prefetch" href="/assets/js/35.fd396ac8.js"><link rel="prefetch" href="/assets/js/36.6a153582.js"><link rel="prefetch" href="/assets/js/37.2b630e97.js"><link rel="prefetch" href="/assets/js/38.748c97b1.js"><link rel="prefetch" href="/assets/js/39.25609498.js"><link rel="prefetch" href="/assets/js/4.20ab2606.js"><link rel="prefetch" href="/assets/js/40.90f0e644.js"><link rel="prefetch" href="/assets/js/41.1be22386.js"><link rel="prefetch" href="/assets/js/42.3e1f06d9.js"><link rel="prefetch" href="/assets/js/43.273832a4.js"><link rel="prefetch" href="/assets/js/44.67b9b9b4.js"><link rel="prefetch" href="/assets/js/45.bb44ce97.js"><link rel="prefetch" href="/assets/js/46.8b471c76.js"><link rel="prefetch" href="/assets/js/47.c2483c9e.js"><link rel="prefetch" href="/assets/js/48.0bd8db23.js"><link rel="prefetch" href="/assets/js/49.8633545b.js"><link rel="prefetch" href="/assets/js/5.77a2d888.js"><link rel="prefetch" href="/assets/js/50.ea4c9352.js"><link rel="prefetch" href="/assets/js/51.ff93f1d0.js"><link rel="prefetch" href="/assets/js/52.c829067e.js"><link rel="prefetch" href="/assets/js/53.97214e76.js"><link rel="prefetch" href="/assets/js/54.967db319.js"><link rel="prefetch" href="/assets/js/55.d423f864.js"><link rel="prefetch" href="/assets/js/56.8716e4eb.js"><link rel="prefetch" href="/assets/js/57.037c823c.js"><link rel="prefetch" href="/assets/js/58.f8cc73b2.js"><link rel="prefetch" href="/assets/js/59.f1ec71ff.js"><link rel="prefetch" href="/assets/js/6.f28c9b9c.js"><link rel="prefetch" href="/assets/js/60.60742d4a.js"><link rel="prefetch" href="/assets/js/62.8cc7ecc3.js"><link rel="prefetch" href="/assets/js/63.e5e4fcd4.js"><link rel="prefetch" href="/assets/js/64.c990d92e.js"><link rel="prefetch" href="/assets/js/65.0dd93d96.js"><link rel="prefetch" href="/assets/js/66.012ff33f.js"><link rel="prefetch" href="/assets/js/67.f8dd5718.js"><link rel="prefetch" href="/assets/js/68.82df1601.js"><link rel="prefetch" href="/assets/js/69.0a42f4fd.js"><link rel="prefetch" href="/assets/js/7.72688c01.js"><link rel="prefetch" href="/assets/js/70.0a4b3461.js"><link rel="prefetch" href="/assets/js/71.7280f8ba.js"><link rel="prefetch" href="/assets/js/72.a4c15353.js"><link rel="prefetch" href="/assets/js/73.dcf3f2dd.js"><link rel="prefetch" href="/assets/js/74.e8b03bbd.js"><link rel="prefetch" href="/assets/js/75.99dbdf4c.js"><link rel="prefetch" href="/assets/js/76.8dcfc3b8.js"><link rel="prefetch" href="/assets/js/77.e794801f.js"><link rel="prefetch" href="/assets/js/78.85d74375.js"><link rel="prefetch" href="/assets/js/79.4c901e16.js"><link rel="prefetch" href="/assets/js/8.263b2f7e.js"><link rel="prefetch" href="/assets/js/80.413dcc1a.js"><link rel="prefetch" href="/assets/js/81.93c9edc1.js"><link rel="prefetch" href="/assets/js/82.afa7e5bb.js"><link rel="prefetch" href="/assets/js/83.de63bbcd.js"><link rel="prefetch" href="/assets/js/84.95facc95.js"><link rel="prefetch" href="/assets/js/85.c6e676ba.js"><link rel="prefetch" href="/assets/js/86.1011c4e9.js"><link rel="prefetch" href="/assets/js/87.ba63a6c3.js"><link rel="prefetch" href="/assets/js/88.dcd35e7a.js"><link rel="prefetch" href="/assets/js/89.497eb1b5.js"><link rel="prefetch" href="/assets/js/9.dc4048f5.js"><link rel="prefetch" href="/assets/js/90.4fb21056.js"><link rel="prefetch" href="/assets/js/91.4829ca52.js"><link rel="prefetch" href="/assets/js/92.8cf99888.js"><link rel="prefetch" href="/assets/js/93.b218cc0c.js"><link rel="prefetch" href="/assets/js/94.baf0d39f.js"><link rel="prefetch" href="/assets/js/95.85be4d3f.js"><link rel="prefetch" href="/assets/js/96.36e87f43.js"><link rel="prefetch" href="/assets/js/97.5dad18b3.js"><link rel="prefetch" href="/assets/js/98.07167967.js"><link rel="prefetch" href="/assets/js/99.25583cc7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ee1f0b8d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="theme-container" data-v-ad130a7c><div data-v-ad130a7c><div id="loader-wrapper" class="loading-wrapper" data-v-d48f4d20 data-v-ad130a7c data-v-ad130a7c><div class="loader-main" data-v-d48f4d20><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div><div data-v-d48f4d20></div></div> <!----> <!----></div> <div class="password-shadow password-wrapper-out is-home" style="display:none;" data-v-262b1d1e data-v-ad130a7c data-v-ad130a7c><h3 class="title" data-v-262b1d1e>Simon的书柜</h3> <p class="description" data-v-262b1d1e>Simon的书柜</p> <label id="box" class="inputBox" data-v-262b1d1e><input type="password" value="" data-v-262b1d1e> <span data-v-262b1d1e>Konck! Knock!</span> <button data-v-262b1d1e>OK</button></label> <div class="footer" data-v-262b1d1e><span data-v-262b1d1e><i class="iconfont reco-theme" data-v-262b1d1e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-262b1d1e>vuePress-theme-reco</a></span> <span data-v-262b1d1e><i class="iconfont reco-other" data-v-262b1d1e></i> <a data-v-262b1d1e>Simon的书柜</a></span> <span data-v-262b1d1e><i class="iconfont reco-copyright" data-v-262b1d1e></i> <a data-v-262b1d1e>2020</a></span></div></div> <div class="hide" data-v-ad130a7c><header class="navbar" data-v-ad130a7c><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Simon的书柜</span></a> <div class="links"><!----> <div class="fullscreen-wrapper screenfull" data-v-669fca12><svg t="1574746366011" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5517" width="200" height="200" class="icon" data-v-669fca12><path d="M223.51420462 330.2102269h1.49573886c0 32.21590925 0.26846576 64.43181848-0.19176196 96.64772772-0.15340924 8.8977269 2.9914769 11.16051113 11.390625 10.96875 19.06107962-0.3835231 38.16051113-0.23011387 57.22159158 0.421875 8.24573887 0.26846576 10.9303981-2.30113613 10.6235788-10.62357962-0.76704538-19.67471576-0.65198887-39.38778425-0.84375-59.0625 0-2.0710231-0.65198887-4.6789769 1.87926197-5.82954538 2.5696019-1.15056848 3.8352269 1.2272731 5.40767037 2.60795462 1.15056848 1.03551113 2.22443152 2.18607962 3.33664728 3.29829538 35.09232962 35.0539769 70.26136387 70.03125 105.16193235 105.27698886 5.59943152 5.63778425 9.47301113 7.47869348 15.83948803 0.61363614 12.54119348-13.5 25.61931848-26.5397731 39.11931848-39.11931849 6.86505652-6.3664769 7.09517038-10.47017038 0.19176114-17.22017037-35.8210231-35.16903424-71.22017038-70.79829538-106.69602228-106.35085189-1.91761387-1.91761387-5.36931848-3.72017038-4.37215924-6.71164812 1.2272731-3.87357962 5.29261387-2.33948887 8.20738613-2.30113613 19.3678981 0.07670462 38.73579538 0.15340924 58.14204539 0.72869348 6.90340925 0.19176113 9.39630652-2.0710231 9.2428981-9.08948886-0.4602269-20.32670462-0.65198887-40.65340925-0.421875-60.98011386 0.07670462-7.1335231-2.76136387-9.01278424-9.47301114-9.05113614-65.31392038-0.30681848-130.66619348-0.76704538-195.98011386-1.53409076-7.74715924-0.11505652-9.47301113 2.68465925-9.43465924 9.81818152 0.30681848 32.484375 0.15340924 65.0071019 0.15340924 97.52982962m433.61079538 466.36363613l20.55681848 0.11505735c0.53693152 0.26846576 1.11221576 0.76704538 1.6875 0.76704538 37.43181848 0.26846576 74.90198887 0.421875 112.37215842 0.84375 6.25142038 0.07670462 7.09517038-3.06818152 7.05681848-8.16903424-0.30681848-23.77840924-0.23011387-47.48011387-0.69034076-71.18181849-0.26846576-14.65056848 1.11221576-29.30113613-0.92045462-43.875l-0.11505652-18.44744265c1.80255652-22.12926113 0.15340924-44.296875 0.53693152-66.42613697 0.11505652-5.5227269-3.14488613-6.7116481-7.86221575-6.71164726-21.24715925 0-42.49431848 0-63.74147773-0.38352312-5.9446019-0.11505652-7.5553981 2.41619348-7.44034077 7.82386387 0.26846576 16.22301113 0.23011387 32.484375 0.26846577 48.70738613v21.09375c-5.13920462-1.61079538-7.28693152-4.83238613-9.77982962-7.32528423-35.51420462-35.4758519-71.10511387-70.9133519-106.3508519-106.65767039-5.59943152-5.67613613-9.08948887-5.5227269-14.3821019 0-13.42329538 13.99857962-27.07670462 27.69034075-41.03693235 41.03693235-5.56107962 5.36931848-5.71448887 8.8210231-0.03835188 14.42045462 35.55255652 35.015625 70.75994348 70.37642038 105.96732961 105.73721577 2.68465925 2.68465925 6.51988613 4.71732962 7.32528342 9.28125-3.29829538 2.109375-6.7883519 1.15056848-10.04829538 1.15056765-19.40625 0-38.73579538-0.15340924-58.14204539-0.26846577-4.52556848 0-8.8210231-0.3835231-8.70596575 6.44318235 0.30681848 21.86079538 0.30681848 43.75994348 0.3835231 65.65909077 0 4.6022731 1.91761387 6.98011387 6.67329539 6.90340923 22.12926113-0.3835231 44.296875 1.265625 66.42613613-0.53693235M513.2272731 90.20170462c113.5227269 0 226.96875 0.11505652 340.453125-0.07670462 27.4602269-0.0383519 49.97301113 9.47301113 66.42613614 31.75568152 11.08380652 14.95738613 14.19034075 32.21590925 14.19034076 50.43323886-0.11505652 109.41903425-0.0383519 218.83806848-0.0383519 328.29545462 0 117.20454538-0.11505652 234.44744348 0.0767038 351.69034076 0.0383519 27.34517038-8.8977269 50.01136387-31.14204538 66.77130734-15.1875 11.50568152-32.59943152 14.765625-51.12357962 14.765625-127.8664769-0.07670462-255.73295462-0.0383519-383.59943152-0.03835272-98.79545462 0-197.59090924-0.15340924-296.38636386 0.07670462-27.72869348 0.07670462-50.6633519-9.12784076-67.34659077-31.83238613-11.0071019-14.95738613-14.19034075-32.13920462-14.15198885-50.43323887 0.11505652-141.59659076 0.07670462-283.23153424 0.07670462-424.8664769 0-85.33380652 0.11505652-170.66761387-0.07670462-256.0397731C90.5852269 143.28125 99.98153424 120.73011387 122.34090925 104.31534075c14.95738613-11.0071019 32.21590925-14.19034075 50.43323885-14.15198885 113.5227269 0.15340924 226.96875 0.07670462 340.453125 0.07670462" p-id="5518" data-v-669fca12></path></svg></div> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/computer/首页.html" class="nav-link"><i class="iconfont undefined"></i>
  计算机基础
</a></div><div class="nav-item"><a href="/java/首页.html" class="nav-link"><i class="iconfont undefined"></i>
  Java
</a></div><div class="nav-item"><a href="/Python/首页.html" class="nav-link"><i class="iconfont undefined"></i>
  Python
</a></div><div class="nav-item"><a href="/middleware/首页.html" class="nav-link"><i class="iconfont undefined"></i>
  中间件
</a></div><div class="nav-item"><a href="/database/首页.html" class="nav-link"><i class="iconfont undefined"></i>
  数据库
</a></div><div class="nav-item"><a href="/frontend/首页.html" class="nav-link"><i class="iconfont undefined"></i>
  前端
</a></div><div class="nav-item"><a href="/middleware/%E3%80%8AKafka%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B%E7%AC%94%E8%AE%B0/.html" class="nav-link"><i class="iconfont undefined"></i>
  技术博客
</a></div><div class="nav-item"><a href="/essay/" class="nav-link"><i class="iconfont undefined"></i>
  随笔
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      GitHub
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Mulander-J" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  GitHub首页
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-ad130a7c></div> <aside class="sidebar" data-v-ad130a7c><nav class="nav-links"><div class="nav-item"><a href="/computer/首页.html" class="nav-link"><i class="iconfont undefined"></i>
  计算机基础
</a></div><div class="nav-item"><a href="/java/首页.html" class="nav-link"><i class="iconfont undefined"></i>
  Java
</a></div><div class="nav-item"><a href="/Python/首页.html" class="nav-link"><i class="iconfont undefined"></i>
  Python
</a></div><div class="nav-item"><a href="/middleware/首页.html" class="nav-link"><i class="iconfont undefined"></i>
  中间件
</a></div><div class="nav-item"><a href="/database/首页.html" class="nav-link"><i class="iconfont undefined"></i>
  数据库
</a></div><div class="nav-item"><a href="/frontend/首页.html" class="nav-link"><i class="iconfont undefined"></i>
  前端
</a></div><div class="nav-item"><a href="/middleware/%E3%80%8AKafka%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97%E3%80%8B%E7%AC%94%E8%AE%B0/.html" class="nav-link"><i class="iconfont undefined"></i>
  技术博客
</a></div><div class="nav-item"><a href="/essay/" class="nav-link"><i class="iconfont undefined"></i>
  随笔
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont undefined"></i>
      GitHub
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/Mulander-J" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont undefined"></i>
  GitHub首页
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/middleware/首页.html" class="sidebar-link">首页</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>《Kafka权威指南》--笔记</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/middleware/《Kafka权威指南》笔记/初识Kafka.html" class="sidebar-link">初识Kafka</a></li><li><a href="/middleware/《Kafka权威指南》笔记/安装Kafka.html" class="sidebar-link">安装Kafka</a></li><li><a href="/middleware/《Kafka权威指南》笔记/Kafka生产者.html" class="active sidebar-link">Kafka生产者</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/middleware/《Kafka权威指南》笔记/Kafka生产者.html#生产者概览" class="sidebar-link">生产者概览</a></li><li class="sidebar-sub-header"><a href="/middleware/《Kafka权威指南》笔记/Kafka生产者.html#创建kafka生产者" class="sidebar-link">创建Kafka生产者</a></li><li class="sidebar-sub-header"><a href="/middleware/《Kafka权威指南》笔记/Kafka生产者.html#发送消息到kafka" class="sidebar-link">发送消息到Kafka</a></li><li class="sidebar-sub-header"><a href="/middleware/《Kafka权威指南》笔记/Kafka生产者.html#生产者的配置" class="sidebar-link">生产者的配置</a></li><li class="sidebar-sub-header"><a href="/middleware/《Kafka权威指南》笔记/Kafka生产者.html#序列化器" class="sidebar-link">序列化器</a></li><li class="sidebar-sub-header"><a href="/middleware/《Kafka权威指南》笔记/Kafka生产者.html#分区" class="sidebar-link">分区</a></li></ul></li><li><a href="/middleware/《Kafka权威指南》笔记/Kafka消费者.html" class="sidebar-link">Kafka消费者</a></li><li><a href="/middleware/《Kafka权威指南》笔记/深入Kafka.html" class="sidebar-link">深入Kafka</a></li><li><a href="/middleware/《Kafka权威指南》笔记/可靠的数据传递.html" class="sidebar-link">可靠的数据传递</a></li><li><a href="/middleware/《Kafka权威指南》笔记/构建数据管道.html" class="sidebar-link">构建数据管道</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Nginx教程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>RabbitMQ教程</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-262b1d1e data-v-ad130a7c><h3 class="title" data-v-262b1d1e>Kafka生产者</h3> <!----> <label id="box" class="inputBox" data-v-262b1d1e><input type="password" value="" data-v-262b1d1e> <span data-v-262b1d1e>Konck! Knock!</span> <button data-v-262b1d1e>OK</button></label> <div class="footer" data-v-262b1d1e><span data-v-262b1d1e><i class="iconfont reco-theme" data-v-262b1d1e></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-262b1d1e>vuePress-theme-reco</a></span> <span data-v-262b1d1e><i class="iconfont reco-other" data-v-262b1d1e></i> <a data-v-262b1d1e>Simon的书柜</a></span> <span data-v-262b1d1e><i class="iconfont reco-copyright" data-v-262b1d1e></i> <a data-v-262b1d1e>2020</a></span></div></div> <div data-v-ad130a7c><main class="page reco-hide"> <div class="page-title"><h1>Kafka生产者</h1> <hr> <div data-v-7b49930f><i class="iconfont reco-account" data-v-7b49930f><span data-v-7b49930f>Simon的书柜</span></i> <!----> <!----> <i class="iconfont reco-tag tags" data-v-7b49930f><span class="tag-item" data-v-7b49930f>
      Kafka
    </span><span class="tag-item" data-v-7b49930f>
      Producer
    </span></i></div></div> <div class="theme-reco-content content__default"><h2 id="生产者概览"><a href="#生产者概览" class="header-anchor">#</a> 生产者概览</h2> <p><img src="/assets/img/202003051526.80469a69.png" alt=""></p> <p>我们从创建一个ProducerRecord对象开始，ProducerRecord对象需要包含目标主题和要发送的内容。我们还可以指定键或分区。在发送ProducerRecord对象时，生产者要先把键和值对象序列化成字节数组，这样它们才能够在网络上传输</p> <p><br>
接下来，数据被传给分区器。如果之前在ProducerRecord对象里指定了分区，那么分区器就不会再做任何事情，直接把指定的分区返回。如果没有指定分区，那么分区器会根据ProducerRecord对象的键来选择一个分区。选好分区以后，生产者就知道该往哪个主题和分区发送这条记录了。紧接着，这条记录被添加到一个记录批次里，这个批次里的所有消息会被发送到相同的主题和分区上。有一个独立的线程负责把这些记录批次发送到相应的broker上</p> <p><br>
服务器在收到这些消息时会返回一个响应。如果消息成功写入Kafka，就返回一个RecordMetaData对象，它包含了主题和分区信息，以及记录在分区里的偏移量。如果写入失败，则会返回一个错误。生产者在收到错误之后会尝试重新发送消息，几次之后如果还是失败，就返回错误信息</p> <h2 id="创建kafka生产者"><a href="#创建kafka生产者" class="header-anchor">#</a> 创建Kafka生产者</h2> <p>要往Kafka写入消息，首先要创建一个生产者对象，并设置一些属性。Kafka生产者有3个必选的属性：</p> <ul><li><p>bootstrap.servers<br>
该属性指定broker的地址清单，地址的格式 host:port。清单里不需要包含所有的broker地址，生产者会从给定的broker里查找到其他 broker的信息。不过建议至少要提供两个broker的信息，一且其中一个宕机，生产者仍然能够连接到集群上</p></li> <li><p>key.seriable<br>
broker希望接收到的消息的键和值都是字节数组。生产者接口允许使用参数化类型，因此可以把Java对象作为键和值发送给broker。这样的代码具有良好的可读性，不过生产者需要知道如何把这些Java对象转换成字节数组。key.seriable必须被设置为一个实现了org.apache.kafka.common.serialization.Serializer接口的类，生产者会使用这个类把键对象序列化成字节数组。Kafka客户端默认提供了ByteArraySerilizer（这个只做很少的事情）、 StringSerilizer和 IntegerSerilizer，因此，如果你只使用常见的几种Java对象类型，那么就没必要实现自己的序列化器。要注意，key.seriable是必须设置的，就算你打算只发送值内容</p></li> <li><p>value.serilizer<br>
与key.serilizer一样，value.serilizer指定的类会将值序列化。如果键和值都是字符串，可以使用与key.serilizer一样的序列化器。如果键是整数类型而值是字符串 ，那么需要使用不同的序列化器</p></li></ul> <p><br>
以下代码片段演示了如何创建一个新的生产者，这里只指定了必要的属性，其它的使用默认配置</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 新建一个Properties对象</span>
<span class="token keyword">private</span> <span class="token class-name">Properties</span> kafkaProps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
kafkaProps<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;bootstrap.servers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;broker1:9092, broker2:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 打算把key和value定义成String类型，所以使用内置的StringSerilizer</span>
kafkaProps<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;key.serilizer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringSerilizer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
kafkaProps<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;value.serilizer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;org.apache.kafka.common.serialization.StringSerilizer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 新建一个生产者对象</span>
producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>kafkaProps<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><br>
实例化生产者对象后，接下来就可以开始发送消息了。发送消息主要有以下3种方式:</p> <ul><li>发送并忘记（fire-and-forget)<br>
我们把消息发送给服务器，但并不关心它是否正常到达。大多数情况下，消息会正常到达，因为Kafka是高可用的，而且生产者会自动尝试重发。不过，使用这种方式有时候 也会丢失一些消息</li> <li>同步发送<br>
我们使用send()方怯发送消息，它会返回一个Future对象，调用get()方法进行等待，就可以知道消息是否发送成功</li> <li>异步发送<br>
我们调用send()方怯，并指定一个回调函数，服务器在返回响应时调用该函数</li></ul> <p><br>
本章的所有例子都使用单线程，但其实生产者是可以使用多线程来发送消息的。刚开始的时候可以使用单个消费者和单个线程。如果需要更高的吞吐量，可以在生产者数量不变的前提下增加线程数量。如果这样做还不够，可以增加生产者数量</p> <h2 id="发送消息到kafka"><a href="#发送消息到kafka" class="header-anchor">#</a> 发送消息到Kafka</h2> <p>最简单的消息发送方式如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 创建一个ProducerRecord对象。这里使用其中一个构造函数，它需要目标主题的名字和要发送的键和</span>
<span class="token comment">// 值对象，它们都是字符串。键和值对象的类型必须与序列化器和生产者对象相匹配</span>
<span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;CustomerCountry&quot;</span><span class="token punctuation">,</span>
   <span class="token string">&quot;Precision Products&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;France&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// 使用生产者的send()方越发送ProducerRecord对象。消息先是被放进缓冲区，然后使用单独的线</span>
  <span class="token comment">// 程发送到服务器端。send()方法会返回一个包含 ProducerRecord的Future对象，不过因为我们会</span>
  <span class="token comment">// 忽略返回值</span>
  producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 可以忽略发送消息时可能发生的错误或在服务器端可能发生的错误，但在发送消息之前，生产者</span>
  <span class="token comment">// 还是有可能发生其他的异常</span>
  e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="同步发送消息"><a href="#同步发送消息" class="header-anchor">#</a> 同步发送消息</h3> <p>最简单的同步消息发送方式如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;CustomerCountry&quot;</span>
  <span class="token punctuation">,</span> <span class="token string">&quot;Precision Products&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;France&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token comment">// producer.send()方住先返回一个Future对象，然后调用Future 象的get()方法等待Kafka响应。</span>
  <span class="token comment">// 如果服务器返回错误，get()方法会抛出异常。如果没有发生错误，我们会得到一个</span>
  <span class="token comment">// RecordMetadata对象，可以用它获取消息的偏移量</span>
  producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果在发送数据之前或者在发送过程中发生了任何错误，比如broker返回了一个不允许重发消息</span>
  <span class="token comment">// 的异常或者已经超过了重发的次数，那么就会抛出异常</span>
  e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>KafkaProducer一般会发生两类错误。其中一类是可重试错误，这类错误可以通过重发消息来解决。比如对于连接错误，可以通过再次建立连接来解决，“无主（no leader）” 错误则可以通过重新为分区选举首领来解决。KafkaProducer可以被配置成自动重试，如果在多次重试后仍无能解决问题，应用程序会收到一个重试异常。另一类错误无出通过重试解决，比如 “消息太大”异常。对于这类错误，KafkaProducer不会进行任何重试，直接抛出异常</p> <h3 id="异步发送消息"><a href="#异步发送消息" class="header-anchor">#</a> 异步发送消息</h3> <p>为了在异步发送消息的同时能够对异常情况进行处理，生产者提供了回调支持。下面是使用回调的一个例子</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 为了使用回调，需要一个实现了org.apache.kafka.clients.producer.Callback接口的类，这个</span>
<span class="token comment">// 类只有一个onCompletion方法</span>
<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">DemoProducerCallback</span> <span class="token keyword">implements</span> <span class="token class-name">Callback</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> recordMetadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果Kafka返回一个错误，onCompletion会抛出一个非空异常</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;CustomerCountry&quot;</span>
  <span class="token punctuation">,</span> <span class="token string">&quot;Biomedical Materials&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;USA&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 发送消息时传入一个会调对象</span>
producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DemoProducerCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="生产者的配置"><a href="#生产者的配置" class="header-anchor">#</a> 生产者的配置</h2> <p>生产者还有很多可配置的参数，在Kafka文档里都有说明，它们大部分都有合理的默认值，所以没有必要去修改它们。不过有几个参数在内存使用、性能和可靠性方面对生产者影响比较大，接下来我们会一一说明</p> <h3 id="acks"><a href="#acks" class="header-anchor">#</a> acks</h3> <p>acks参数指定了必须要有多少个分区副本收到消息，生产者才会认为消息写入是成功的。这个参数对消息丢失的可能性有重要影响。该参数有如下选项</p> <ul><li>如果acks=0，生产者在成功写入消息之前不会等待任何来自服务器的响应。这种方式可能会存在消息丢失，但是有很高的吞吐量</li> <li>如果acks=1，只要集群的首领节点收到消息，生产者就会收到一个来自服务器的成功响应。如果消息无法到达首领节点， 生产者会收到一个错误响应，为了避免数据丢失，生产者会重发消息。不过，如果一个没有收到消息的节点成为新首领，消息还是会丢失。这个时候的吞吐量取决于使
同步发送还是异步发送</li> <li>如果acks=all，只有当所有参与复制的节点全部收到消息时，生产者才会收到一个来自服务器的成功响应。这种模式是最安全的，它可以保证不止一个服务器收到消息，就算有服务器发生崩溃，整个集群仍然可以运行,但是延迟较高</li></ul> <h3 id="buffer-memory"><a href="#buffer-memory" class="header-anchor">#</a> buffer.memory</h3> <p>该参数用来设置生产者内存缓冲区的大小，生产者用它缓冲要发送到服务器的消息。如果应用程序发送消息的速度超过发送到服务器的速度，会导致生产者空间不足。这个时候，send()方法调用要么被阻塞，要么抛出异常，取决于如何设置block.on.buffer.full（在 0.9.0.0 版本里被替换成了max.block.ms，表示在抛出异常之前可以阻塞一段时间）</p> <h3 id="compression-type"><a href="#compression-type" class="header-anchor">#</a> compression.type</h3> <p>默认情况下，消息发送时不会被压缩。该参数可以设置为 snappy、 gzip或lz4，它指定了消息被发送给broker之前使用哪一种压缩算也进行压缩</p> <h3 id="retries"><a href="#retries" class="header-anchor">#</a> retries</h3> <p>生产者从服务器收到的错误有可能是临时性的错误（比如分区找不到首领）。在这种情况下，retries参数的值决定了生产者可以重发消息的次数，如果达到这个次数，生产者会放弃重试并返回错误。默认情况下，生产者会在每次重试之间等待100ms，不过可以通过retry.backoff.ms参数来改变这个时间间隔</p> <h3 id="batch-size"><a href="#batch-size" class="header-anchor">#</a> batch.size</h3> <p>当有多个消息需要被发送到同一个分区时，生产者会把它们放在同一个批次里。该参数指定了一个批次可以使用的内存大小，按照字节数计算（而不是消息个数）。当批次被填满， 批次里的所有消息会被发送出去。不过生产者井不一定都会等到批次被填满才发送，半满的批次，甚至只包含一个消息的批次也有可能被发送。所以就算把批次大小设置得很大，也不会造成延迟，只是会占用更多的内存而已。但如果设置得太小，因为生产者需要更频繁地发送消息，会增加一些额外的开销</p> <h3 id="linger-ms"><a href="#linger-ms" class="header-anchor">#</a> linger.ms</h3> <p>该参数指定了生产者在发送批次之前等待更多消息加入批次的时间。 KafkaProducer会在批次填满或linger.ms达到上限时把批次发送出去。默认情况下，只要有可用的线程， 生产者就会把消息发送出去，就算批次里只有一个消息。把linger.ms设置成比0 的数，让生产者在发送批次之前等待一会儿，使更多的消息加入到这个批次。虽然这样会增加延迟，但也会提升吞吐量</p> <h3 id="client-id"><a href="#client-id" class="header-anchor">#</a> client.id</h3> <p>该参数可以是任意的字符串，服务器会用它来识别消息的来源，还可以用在日志和配额指标里</p> <h3 id="max-in-flight-requests-per-connection"><a href="#max-in-flight-requests-per-connection" class="header-anchor">#</a> max.in.flight.requests.per.connection</h3> <p>该参数指定了生产者在收到服务器晌应之前可以发送多少个消息。它的值越高，就会占用越多的内存，不过也会提升吞吐量。把它设为1可以保证消息是按照发送的顺序写入服务器的，即使发生了重试</p> <h3 id="timeout-ms、request-timeout-ms和metadata-fetch-timeout-ms"><a href="#timeout-ms、request-timeout-ms和metadata-fetch-timeout-ms" class="header-anchor">#</a> timeout.ms、request.timeout.ms和metadata.fetch.timeout.ms</h3> <p>request.timeout.ms指定了生产者在发送数据时等待服务器返回响应的时间，metadata.fetch.timeout.ms指定了生产者在获取元数据（比如目标分区的首领是谁）时等待服务器返回响应的时间。如果等待响应超时，那么生产者要么重试发送数据，要么返回一个错误 （抛出异常或执行回调）。timeout.ms指定了broker等待同步副本返回消息确认的时间，与asks的配置相匹配一一如果在指定时间内没有收到同步副本的确认，那么 broker就会返回一个错误</p> <h3 id="max-block-ms"><a href="#max-block-ms" class="header-anchor">#</a> max.block.ms</h3> <p>该参数指定了在调用send()方法或使用partitionsFor方法获取元数据时生产者的阻塞时间。当生产者的发送缓冲区已满，或者没有可用的元数据时，这些方法就会阻塞。在阻塞时间达到max.block.ms时，生产者会抛出超时异常</p> <h3 id="max-request-size"><a href="#max-request-size" class="header-anchor">#</a> max.request.size</h3> <p>该参数用于控制生产者发送的请求大小。它可以指能发送的单个消息的最大值，也可以指单个请求里所有消息总的大小。broker对可接收的消息最大值也有自己的限制（message.max.bytes），所以两边的配置最好可以匹配，避免生产者发送的消息被broker拒绝</p> <h3 id="receive-buffer-bytes和send-buffer-bytes"><a href="#receive-buffer-bytes和send-buffer-bytes" class="header-anchor">#</a> receive.buffer.bytes和send.buffer.bytes</h3> <p>这两个参数分别指定了TCP socket接收和发送数据包的缓冲区大小。如果它们被设为-1 , 就使用操作系统的默认值。如果生产者或消费者与broker处于不同的数据中心，那么可以适当增大这些值，因为跨数据中心的网络一般都有比较高的延迟和比较低的带宽</p> <h2 id="序列化器"><a href="#序列化器" class="header-anchor">#</a> 序列化器</h2> <h3 id="自定义序列化器"><a href="#自定义序列化器" class="header-anchor">#</a> 自定义序列化器</h3> <p>如果发送到Kafka的对象不是简单的字符串或整型，那么可以使用序列化框架来创建消息记录，如Avro、Thrift或Protobuf，或者使用自定义序列化器。我们强烈建议使用通用的序列化框架。在此之前我们先通过一个自定义序列化器来了解其工作原理</p> <p><br>
假如创建了一个简单的类来表示一个客户：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Customer</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> customerID<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> customerName<span class="token punctuation">;</span>

  <span class="token comment">// 省略getter、setter和构造方法</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>现在我们要为这个类创建一个序列化器，它看起来可能是这样的：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerSerializer</span> <span class="token keyword">implements</span> <span class="token class-name">Serializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Customer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span> configs<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不做任何配置</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token comment">/**
  Customer对象被序列化成：
  表示CustomerID的4字节整数
  表示CustomerName长度的4字节整数（如果CustomerName为空，则长度为0）
  表示CustomerName的N个字节
  */</span>
  <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Customer</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> serializedName<span class="token punctuation">;</span>
      <span class="token keyword">int</span> stringSize<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          serializedName <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          stringSize <span class="token operator">=</span> serializedName<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          serializedName <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
          stringSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> stringSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      buffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">getID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      buffer<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span>stringSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      buffer<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>serializedName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> buffer<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SerializationException</span><span class="token punctuation">(</span><span class="token string">&quot;Serializing Error&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 不需要关闭任何东西</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>这个序列化器太过脆弱，如果Customer字段发生改变，那我序列化和反序列化就可能会出现新旧消息的兼容问题，而且如果序列化器发生改变，那么调用这个序列化器的地方都要更改代码。因此，我们不建议使用自定义序列化器，而是使用已有的序列化器和反序列化器，比如JSON、Avro、Thrift或 Protobuf</p> <h3 id="使用avro序列化"><a href="#使用avro序列化" class="header-anchor">#</a> 使用Avro序列化</h3> <p>Apache  Avro （以下简称 Avro）是一种与编程语言无关的序列化格式。 Doug Cutting创建了这个项目，目的是提供一种共享数据文件的方式。 Avro数据通过与语言无关的schema来定义。schema通过 JSON来描述，数据被序列化成二进制文件或JSON文件，不过一般会使用二进制文件。 Avro在读写文件时需要用到schema, schema一般会被内嵌在数据文件里。 Avro有一个很有意思的特性是，当负责写消息的应用程序使用了新的schema，负责读消息的应用程序可以继续处理消息而无需做任何改动，这个特性使得它特别适合用在像Kafka这样的消息系统上</p> <p><br>
假设最初的schema是这样的：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;namespace&quot;</span><span class="token operator">:</span> <span class="token string">&quot;customerManagement.avro&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;record&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Customer&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;fields&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;int&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;faxNumber&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;null&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">&quot;default&quot;</span><span class="token operator">:</span> <span class="token string">&quot;null&quot;</span><span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>之后我们将faxNumber变成了email字段：</p> <div class="language-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span><span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;email&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;null&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">&quot;default&quot;</span><span class="token operator">:</span> <span class="token string">&quot;null&quot;</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在应用程序升级之后，getEmail()方法取代了getFaxNumber()方法。如果碰到一个使用旧schema构建的消息，那么getEmail()方法会返回 null，因为旧消息不包含邮件地址。现在可以看出使用Avro的好处了：我们修改了消息的schema，但并没有更新所有负责读取数据的应用程序，而这样仍然不会出现异常或阻断性错误，也不需要对现有数据进行大幅更新</p> <p><br>
不过这里有以下两个需要注意的地方：</p> <ul><li>用于写入数据和读取数据的schema必须是相互兼容的。Avro文档提到了一些兼容性原则</li> <li>反序列化器需要用到用于写入数据的schema，即使它可能与用于读取数据的schema不一样。Avro数据文件里就包含了用于写入数据的schema，不过在Kafka里有一种更好的处理方式</li></ul> <h3 id="在kafka里使用avro"><a href="#在kafka里使用avro" class="header-anchor">#</a> 在Kafka里使用Avro</h3> <p>Avro的数据文件里包含了整个schema，不过这样的开销是可接受的。但是如果在每条Kafka记录里都嵌入schema，会让记录的大小成倍地增加。不过不管怎样，在读取记录时仍然需要用到整个schema，所以要先找到schema。我们遵循通用的结构模式并使用 “schema 注册表”来达到目的。 schema注册表并不属于Kafka，现在已经有一些开源的schema注册表实现。在这个例子里，我们使用的是Confluent Schema Registry。该注册表 的代码可以在GitHub上找到，你也可以把它作为Confluent平台的一部分进行安装。如果你决定使用这个注册表，可以参考它的文档</p> <p><br>
我们把所有写入数据需要用到的schema保存在注册表里，然后在记录里引用schema的标识符。负责读取数据的应用程序使用标识符从注册表里拉取 schema来反序列化记录。序列化器和反序列化器分别负责处理schema的注册和拉取。Avro序列化器的使用方怯与其他序列化器是一样的<br> <img src="/assets/img/202003091301.300dd618.png" alt=""><br>
下面的例子展示了如何把生成的Avro对象发送到Kafka（关于如何使用Avro生成代码请参考Avro文档）：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Properties</span> prosps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;bootstrap.servers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;localhost:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用Avro的KafkaAvroSerilizer来序列化对象。</span>
props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;key.serializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;io.confluent.kafka.serializers.KafkaAvroSerializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;value.serializer&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;io.confluent.kafka.serializers.KafkaAvroSerializer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//  schema.registry.url是一个新的参数，指向schema的存储位置</span>
props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;schema.registry.url&quot;</span><span class="token punctuation">,</span> schemaUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">String</span> topic <span class="token operator">=</span> <span class="token string">&quot;customerContacts&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// Customer是生成的对象。我们会告诉生产者Customer对象就是记录的值</span>
<span class="token class-name">Prodicer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Customer</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Customer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 不断生成事件，直到按下Ctrl+C</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">Customer</span> customer <span class="token operator">=</span> <span class="token class-name">CustomerGenerator</span><span class="token punctuation">.</span><span class="token function">getNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>customer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 实例化一个ProducerRecord对象，并指定Customer为值的类型，然后再传给它一个Customer对象</span>
  <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Customer</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> customer<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">,</span> customer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 把Customer对象作为记录发送出去，KafkaAvroSerializer会处理剩下的事情</span>
  producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>record<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h2 id="分区"><a href="#分区" class="header-anchor">#</a> 分区</h2> <p>在之前的例子里，ProducerRecord对象包含了目标主题、键和值。 Kafka的消息是一个个键值对，ProducerRecord对象可以只包含目标主题和值，键可以设置为默认的null，不过大多数应用程序会用到键。键有两个用途：可以作为消息的附加信息，也可以用来决定消息该被写到主题的哪个分区。拥有相同键的消息将被写到同一个分区。 也就是说，如果一个进程只从一个主题的分区读取数据，那么具有相 同键的所有记录都会被该进程读取</p> <p><br>
如果键值为null，并且使用了默认的分区器，那么记录将被随机地发送到主题内各个可用的分区上。分区器使用轮询（Round Robin）算法将消息均衡地分布到各个分区上。 如果键不为空，并且使用了默认的分区器，那么Kafka会对键进行散列（使用Kafka自己的散列算棒，即使升级Java版本，散列值也不会发生变化），然后根据散列值把消息映射到特定的分区上。这里的关键之处在于，同一个键总是被映射到同一个分区上，所以在进行映射时，我们会使用主题所有的分区，而不仅仅是可用的分区。这也意味着，如果写入数据的分区是不可用的，那么就会发生错误。但这种情况很少发生。只有在不改变主题分区数量的情况下，键与分区之间的映射才能保持不变。在从分区读取数据肘，可以进行各种优化。不过，一旦主题增加了新的分区，这些就无陆保证了，旧数据仍然留在之前的分区，但新的记录可能被写到其他分区上。 如果要使用键来映射分区，那么最好在创建主题的时候就把分区规划好，而且永远不要增加新分区</p> <p><br> <strong>实现自定义分区策略</strong></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> bananaPartitioner <span class="token keyword">implements</span> <span class="token class-name">Partitioner</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> configs<span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> value
              <span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PartitionInfo</span><span class="token punctuation">&gt;</span></span> partitions <span class="token operator">=</span> cluster<span class="token punctuation">.</span><span class="token function">partitionsForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> numPartitions <span class="token operator">=</span> partitions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>keyBytes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key instanceOf <span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throws</span> <span class="token keyword">new</span> 
        <span class="token class-name">InvaliRecordException</span><span class="token punctuation">(</span><span class="token string">&quot;we expect all messages to have customer name as key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span>key<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;Banana&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> numPartitions<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 其它记录散列到其它分区</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">murmur2</span><span class="token punctuation">(</span>keyBytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>numPartitions <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">3/9/2020, 11:41:17 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/middleware/《Kafka权威指南》笔记/安装Kafka.html" class="prev">
          安装Kafka
        </a></span> <span class="next"><a href="/middleware/《Kafka权威指南》笔记/Kafka消费者.html">
          Kafka消费者
        </a>
        →
      </span></p></div> </main> <!----> <div class="comments-wrapper" data-v-ad130a7c><!----></div></div></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;background-color:rgba(231, 234, 241,.5);display:none;" data-v-3a5f5fc5 data-v-3a5f5fc5><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-3a5f5fc5><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-3a5f5fc5></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-3a5f5fc5></path></svg></div></div></div>
    <script src="/assets/js/app.8e4ddb9b.js" defer></script><script src="/assets/js/3.ba518dde.js" defer></script><script src="/assets/js/1.86969b9d.js" defer></script><script src="/assets/js/61.ec1a5950.js" defer></script>
  </body>
</html>
